var F=Object.defineProperty;var _=(i,t,o)=>t in i?F(i,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[t]=o;var d=(i,t,o)=>(_(i,typeof t!="symbol"?t+"":t,o),o);import{V as u}from"./p5utils.fe4d08ff.js";const z=(i,t)=>{if(t.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const o=A(i,t);if(!o)return;const n=i.restitution*t.restitution,e=i.friction*t.friction,s=i.position.x,c=i.position.y,l=i.position.x+i.geometry.vector.x,p=i.position.y+i.geometry.vector.y,m=t.position.x,h=t.position.y,r=t.position.x+t.velocity.x,f=t.position.y+t.velocity.y;let a=(p-c)/(l-s),y=(f-h)/(r-m);if(a=[1/0,-1/0].includes(a)?360:a,y=[1/0,-1/0].includes(y)?360:y,(a-y)/(1+a*y)===0){const P=n,q=e;return{bouncedVelocity:t.velocity.multiplyScalar(1-q).multiplyScalar(-P),intersection:o}}const x=l-s,C=p-c,V=new u(-C,x),j=new u(C,-x),W=o.clone().add(V),D=o.clone().add(j);let w;t.position.distanceSq(W)<t.position.distanceSq(D)?w=V:w=j;const E=w.clone().normalize(),L=t.velocity.clone(),T=E.multiplyScalar(L.dot(E)),G=L.subtract(T),I=n,N=e;return{bouncedVelocity:G.multiplyScalar(1-N).subtract(T.multiplyScalar(I)),intersection:o}},A=(i,t)=>{if(t.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const o=i.position.clone(),n=i.position.clone().add(i.geometry.vector),e=t.position.clone(),s=t.geometry.r,c=n.clone().subtract(o),l=o.clone().subtract(e),p=c.dot(c),m=l.dot(c)*2,h=l.dot(l)-s*s;let r=m*m-4*p*h;if(r<0)return;r=Math.sqrt(r);const f=(-m-r)/(2*p),a=(-m+r)/(2*p),y=f>=0&&f<=1,b=a>=0&&a<=1;if(y&&b)return o.add(c.multiplyScalar(f+(a-f)*.5));if(y)return o.add(c.multiplyScalar(1));if(b)return o.add(c.multiplyScalar(0))};class H{constructor(t){d(this,"gravityEnabled");d(this,"dimensions");d(this,"t");d(this,"objects");d(this,"gravity",new u(0,-9.8));d(this,"antiGravity",new u(0,9.8));d(this,"drag",.001);d(this,"dt",.005);d(this,"reporter");this.gravityEnabled=t.enableGravity??!0,this.dimensions=t.dimensions||new u(100,100),this.objects=[],this.t=0,this.reporter=t.reporter||console.log}toggleGravity(){this.gravityEnabled=!this.gravityEnabled}addObject(t){this.objects.push(t)}applyGravity(t){t.acceleration.push(this.gravity)}applyForce(t,o){t.acceleration.push(o)}applyDynamics(t,o){if(o.fixed)return;this.gravityEnabled&&this.applyGravity(o);const n=new u(0,0);for(;o.acceleration.length;){const s=o.acceleration.pop();s&&n.add(s)}n.divideScalar(o.m);const e=1-this.drag;o.velocity.add(n.multiplyScalar(t)).multiplyScalar(e),o.position.add(o.velocity.clone().multiplyScalar(t))}applyCollisions(t){const o=this.objects.filter(e=>e.geometry.type==="sphere"),n=this.objects.filter(e=>e.geometry.type==="line");for(const e of o){e.data.isColliding=!1;const s=new u(0,0);let c=0;for(const l of n){l.data.isColliding=!1;const p=z(l,e);if(!p)continue;const{bouncedVelocity:m,intersection:h}=p;l.data.isColliding=!0,l.collisionListener(),c++,s.add(m);const r=e.position.clone().subtract(h),f=r.length();if(f<=e.geometry.r){const y=e.geometry.r-f;r.normalize().multiplyScalar(y),e.position.add(r)}}c>0&&(s.divideScalar(c),e.velocity.copy(s),e.position.add(e.velocity.clone().multiplyScalar(t)),e.data.isColliding=!0,e.collisionListener(),e.acceleration.push(this.antiGravity))}}_step(t){this.applyCollisions(t);for(const o of this.objects)this.applyDynamics(t,o)}stepFixedDt(){const o=Date.now()/1e3;v=o-g,g=o,this._step(.01),this.t+=.01,this.reporter&&this.reporter({...this,frameTime:v})}stepAccumulator(){const t=this.dt,o=Date.now()/1e3;g===0&&(g=o),v=o-g,g=o,S+=v;let n=0;for(;S>=t&&n<5;)n++,this._step(t),S-=t,this.t+=t,this.reporter&&this.reporter({...this,frameTime:v})}step(){this.stepAccumulator()}}let g=0,v=0,S=0;const J=i=>{var t,o;return{geometry:i.geometry,m:i.mass??1,position:((t=i.position)==null?void 0:t.clone())??new u(0,0),velocity:((o=i.velocity)==null?void 0:o.clone())??new u(0,0),acceleration:[],restitution:i.restitution??.9,friction:i.friction??.4,fixed:i.fixed??!1,data:{isColliding:!1},collisionListener:i.collisionListener||(()=>{})}};export{H as W,J as c};
