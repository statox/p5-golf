var L=Object.defineProperty;var W=(i,o,t)=>o in i?L(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t;var r=(i,o,t)=>(W(i,typeof o!="symbol"?o+"":o,t),t);import{V as d}from"./p5utils.fe4d08ff.js";const D=(i,o)=>{if(o.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const t=G(i,o);if(!t)return;const s=i.restitution*o.restitution,l=i.friction*o.friction,n=i.position.x,e=i.position.y,y=i.position.x+i.geometry.vector.x,m=i.position.y+i.geometry.vector.y,a=y-n,p=m-e,c=new d(-p,a),f=new d(p,-a),u=t.clone().add(c),w=t.clone().add(f);let h;o.position.distanceSq(u)<o.position.distanceSq(w)?h=c:h=f;const S=h.clone().normalize(),C=o.velocity.clone(),x=S.multiplyScalar(C.dot(S)),E=C.subtract(x),j=s,V=l;return{bouncedVelocity:E.multiplyScalar(1-V).subtract(x.multiplyScalar(j)),intersection:t}},G=(i,o)=>{if(o.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const t=i.position.clone(),s=i.position.clone().add(i.geometry.vector),l=o.position.clone(),n=o.geometry.r,e=s.clone().subtract(t),y=t.clone().subtract(l),m=e.dot(e),a=y.dot(e)*2,p=y.dot(y)-n*n;let c=a*a-4*m*p;if(c<0)return;c=Math.sqrt(c);const f=(-a-c)/(2*m),u=(-a+c)/(2*m),w=f>=0&&f<=1,h=u>=0&&u<=1;if(w&&h)return t.add(e.multiplyScalar(f+(u-f)*.5));if(w)return t.add(e.multiplyScalar(1));if(h)return t.add(e.multiplyScalar(0))};class q{constructor(o){r(this,"gravityEnabled");r(this,"dimensions");r(this,"t");r(this,"objects");r(this,"gravity",new d(0,-9.8));r(this,"antiGravity",new d(0,9.8));r(this,"drag",.001);r(this,"dt",.005);r(this,"reporter");this.gravityEnabled=o.enableGravity??!0,this.dimensions=o.dimensions||new d(100,100),this.objects=[],this.t=0,this.reporter=o.reporter||console.log}toggleGravity(){this.gravityEnabled=!this.gravityEnabled}addObject(o){this.objects.push(o)}applyGravity(o){o.acceleration.push(this.gravity)}applyForce(o,t){o.acceleration.push(t)}applyDynamics(o,t){this.gravityEnabled&&this.applyGravity(t);const s=new d(0,0);for(;t.acceleration.length;){const n=t.acceleration.pop();n&&s.add(n)}s.divideScalar(t.m);const l=1-this.drag;t.velocity.add(s.multiplyScalar(o)).multiplyScalar(l),t.position.add(t.velocity.clone().multiplyScalar(o))}applyCollisions(o){const t=this.objects.find(e=>e.geometry.type==="sphere"),s=this.objects.filter(e=>e.geometry.type==="line");if(!t)throw new Error("No sphere in world");t.data.isColliding=!1;const l=new d(0,0);let n=0;for(const e of s){e.data.isColliding=!1;const y=D(e,t);if(!y)continue;const{bouncedVelocity:m,intersection:a}=y;e.data.isColliding=!0,e.collisionListener(),n++,l.add(m);const p=t.position.clone().subtract(a),c=p.length();if(c<=t.geometry.r){const u=t.geometry.r-c;p.normalize().multiplyScalar(u),t.position.add(p)}}n>0&&(l.divideScalar(n),t.velocity.copy(l),t.position.add(t.velocity.clone().multiplyScalar(o)),t.data.isColliding=!0,t.collisionListener(),t.acceleration.push(this.antiGravity))}_step(o){this.applyCollisions(o);for(const t of this.objects)t.fixed||this.applyDynamics(o,t)}stepFixedDt(){const t=Date.now()/1e3;v=t-g,g=t,this._step(.01),this.t+=.01,this.reporter&&this.reporter({...this,frameTime:v})}stepAccumulator(){const o=this.dt,t=Date.now()/1e3;g===0&&(g=t),v=t-g,g=t,b+=v;let s=0;for(;b>=o&&s<5;)s++,this._step(o),b-=o,this.t+=o,this.reporter&&this.reporter({...this,frameTime:v})}step(){this.stepAccumulator()}}let g=0,v=0,b=0;const F=i=>{var o,t;return{geometry:i.geometry,m:i.mass??1,position:((o=i.position)==null?void 0:o.clone())??new d(0,0),velocity:((t=i.velocity)==null?void 0:t.clone())??new d(0,0),acceleration:[],restitution:i.restitution??.9,friction:i.friction??.4,fixed:i.fixed??!1,data:{isColliding:!1},collisionListener:i.collisionListener||(()=>{})}};export{q as W,F as c};
