var F=Object.defineProperty;var _=(i,o,t)=>o in i?F(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t;var a=(i,o,t)=>(_(i,typeof o!="symbol"?o+"":o,t),t);import{V as d}from"./p5utils.fe4d08ff.js";const z=(i,o)=>{if(o.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const t=A(i,o);if(!t)return;const n=i.restitution*o.restitution,l=i.friction*o.friction,c=i.position.x,e=i.position.y,y=i.position.x+i.geometry.vector.x,p=i.position.y+i.geometry.vector.y,f=o.position.x,m=o.position.y,r=o.position.x+o.velocity.x,h=o.position.y+o.velocity.y;let s=(p-e)/(y-c),u=(h-m)/(r-f);if(s=[1/0,-1/0].includes(s)?360:s,u=[1/0,-1/0].includes(u)?360:u,(s-u)/(1+s*u)===0){const P=n,q=l;return{bouncedVelocity:o.velocity.multiplyScalar(1-q).multiplyScalar(-P),intersection:t}}const x=y-c,C=p-e,V=new d(-C,x),E=new d(C,-x),W=t.clone().add(V),D=t.clone().add(E);let w;o.position.distanceSq(W)<o.position.distanceSq(D)?w=V:w=E;const j=w.clone().normalize(),L=o.velocity.clone(),T=j.multiplyScalar(L.dot(j)),G=L.subtract(T),N=n,I=l;return{bouncedVelocity:G.multiplyScalar(1-I).subtract(T.multiplyScalar(N)),intersection:t}},A=(i,o)=>{if(o.geometry.type!=="sphere"||i.geometry.type!=="line")throw new Error("invalid geometry");const t=i.position.clone(),n=i.position.clone().add(i.geometry.vector),l=o.position.clone(),c=o.geometry.r,e=n.clone().subtract(t),y=t.clone().subtract(l),p=e.dot(e),f=y.dot(e)*2,m=y.dot(y)-c*c;let r=f*f-4*p*m;if(r<0)return;r=Math.sqrt(r);const h=(-f-r)/(2*p),s=(-f+r)/(2*p),u=h>=0&&h<=1,b=s>=0&&s<=1;if(u&&b)return t.add(e.multiplyScalar(h+(s-h)*.5));if(u)return t.add(e.multiplyScalar(1));if(b)return t.add(e.multiplyScalar(0))};class H{constructor(o){a(this,"gravityEnabled");a(this,"dimensions");a(this,"t");a(this,"objects");a(this,"gravity",new d(0,-9.8));a(this,"antiGravity",new d(0,9.8));a(this,"drag",.001);a(this,"dt",.005);a(this,"reporter");this.gravityEnabled=o.enableGravity??!0,this.dimensions=o.dimensions||new d(100,100),this.objects=[],this.t=0,this.reporter=o.reporter||console.log}toggleGravity(){this.gravityEnabled=!this.gravityEnabled}addObject(o){this.objects.push(o)}applyGravity(o){o.acceleration.push(this.gravity)}applyForce(o,t){o.acceleration.push(t)}applyDynamics(o,t){if(t.fixed)return;this.gravityEnabled&&this.applyGravity(t);const n=new d(0,0);for(;t.acceleration.length;){const c=t.acceleration.pop();c&&n.add(c)}n.divideScalar(t.m);const l=1-this.drag;t.velocity.add(n.multiplyScalar(o)).multiplyScalar(l),t.position.add(t.velocity.clone().multiplyScalar(o))}applyCollisions(o){const t=this.objects.find(e=>e.geometry.type==="sphere"),n=this.objects.filter(e=>e.geometry.type==="line");if(!t)throw new Error("No sphere in world");t.data.isColliding=!1;const l=new d(0,0);let c=0;for(const e of n){e.data.isColliding=!1;const y=z(e,t);if(!y)continue;const{bouncedVelocity:p,intersection:f}=y;e.data.isColliding=!0,e.collisionListener(),c++,l.add(p);const m=t.position.clone().subtract(f),r=m.length();if(r<=t.geometry.r){const s=t.geometry.r-r;m.normalize().multiplyScalar(s),t.position.add(m)}}c>0&&(l.divideScalar(c),t.velocity.copy(l),t.position.add(t.velocity.clone().multiplyScalar(o)),t.data.isColliding=!0,t.collisionListener(),t.acceleration.push(this.antiGravity))}_step(o){this.applyCollisions(o);for(const t of this.objects)this.applyDynamics(o,t)}stepFixedDt(){const t=Date.now()/1e3;v=t-g,g=t,this._step(.01),this.t+=.01,this.reporter&&this.reporter({...this,frameTime:v})}stepAccumulator(){const o=this.dt,t=Date.now()/1e3;g===0&&(g=t),v=t-g,g=t,S+=v;let n=0;for(;S>=o&&n<5;)n++,this._step(o),S-=o,this.t+=o,this.reporter&&this.reporter({...this,frameTime:v})}step(){this.stepAccumulator()}}let g=0,v=0,S=0;const J=i=>{var o,t;return{geometry:i.geometry,m:i.mass??1,position:((o=i.position)==null?void 0:o.clone())??new d(0,0),velocity:((t=i.velocity)==null?void 0:t.clone())??new d(0,0),acceleration:[],restitution:i.restitution??.9,friction:i.friction??.4,fixed:i.fixed??!1,data:{isColliding:!1},collisionListener:i.collisionListener||(()=>{})}};export{H as W,J as c};
